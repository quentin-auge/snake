<html>
  <head>
    <style>
      #canvas
      {
        border: solid;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"  width="800" height="600"></canvas>

    <script>
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');

      const grid = {
        step: 30,
        width: 30,
        height: 20
      };

      canvas.width = grid.width * grid.step;
      canvas.height = grid.height * grid.step;

      const frameRate = 15;
      frameIndex = 0;

      class Snake
      {
        constructor(x, y, size)
        {
          this.body = this.initialBody(x, y, size);
          this.orientRight();
        }

        initialBody(x, y, size)
        {
        	var body = [];
        	var i = 0;
        	while (i < size)
        	{
        		if (i >= grid.width)
        		{
        			throw `x = ${i} out of range`
        		}

        		body.push({x: x + i, y: y})

        		i++;
        	}

        	return body;
        }

        orientLeft()
        {
          this.dx = -1;
          this.dy = 0;
        }

        orientUp()
        {
          this.dx = 0;
          this.dy = -1;
        }

        orientRight()
        {
          this.dx = 1;
          this.dy = 0;
        }

        orientDown()
        {
          this.dx = 0;
          this.dy = 1;
        }

        step()
        {
          // Pop tail
          this.body.shift()

          // Push new head
          var head = this.body[this.body.length - 1]
          var newHead = {
            x: (head.x + this.dx + grid.width) % grid.width,
            y: (head.y + this.dy + grid.height) % grid.height
          }
          this.body.push(newHead)
        }

        draw()
        {
          ctx.fillStyle = 'blue';
          this.body.forEach(function(square)
          {
            ctx.fillRect(square.x * grid.step, square.y * grid.step, grid.step, grid.step);
          })
        }
      }

      snake = new Snake(0, 0, 3);

      function loop()
      {
        requestAnimationFrame(loop);

        // Apply frame rate
        frameIndex = (frameIndex + 1) % Math.floor(60 / frameRate)
        if (frameIndex != 0)
          return

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        snake.step()
        snake.draw()
      }

      requestAnimationFrame(loop);

      function keydown(e)
      {
        switch(e.keyCode)
        {
          case 37:
            snake.orientLeft();
            break;
          case 38:
            snake.orientUp();
            break;
          case 39:
            snake.orientRight();
            break;
          case 40:
            snake.orientDown();
            break;
        }
      }

      window.addEventListener('keydown', keydown, false);
    </script>
  </body>
</html>
